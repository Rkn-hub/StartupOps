<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Analytics - StartupOps Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <style>
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .conversation-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8 text-center">ðŸ“Š Chatbot Analytics Dashboard</h1>
        
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card p-6 rounded-lg text-center">
                <h3 class="text-lg font-semibold mb-2">Total Conversations</h3>
                <p id="totalConversations" class="text-3xl font-bold">-</p>
            </div>
            <div class="stat-card p-6 rounded-lg text-center">
                <h3 class="text-lg font-semibold mb-2">Qualified Leads</h3>
                <p id="qualifiedLeads" class="text-3xl font-bold">-</p>
            </div>
            <div class="stat-card p-6 rounded-lg text-center">
                <h3 class="text-lg font-semibold mb-2">Avg Messages/Chat</h3>
                <p id="avgMessages" class="text-3xl font-bold">-</p>
            </div>
            <div class="stat-card p-6 rounded-lg text-center">
                <h3 class="text-lg font-semibold mb-2">Conversions</h3>
                <p id="conversions" class="text-3xl font-bold">-</p>
            </div>
        </div>

        <!-- Recent Conversations -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-4">ðŸ”¥ Recent Qualified Leads</h2>
            <div id="qualifiedLeadsList" class="space-y-4">
                <!-- Qualified leads will be loaded here -->
            </div>
        </div>

        <!-- All Conversations -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-4">ðŸ’¬ Recent Conversations</h2>
            <div id="conversationsList" class="space-y-4">
                <!-- Conversations will be loaded here -->
            </div>
        </div>

        <!-- Popular Intents -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-4">ðŸ“ˆ Popular Topics</h2>
            <div id="popularIntents" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- Popular intents will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let supabase;

        // Initialize Supabase
        window.addEventListener('load', async () => {
            supabase = window.supabase;
            if (supabase) {
                await loadAnalytics();
                await loadQualifiedLeads();
                await loadRecentConversations();
                await loadPopularIntents();
            } else {
                console.error('Supabase not initialized');
            }
        });

        async function loadAnalytics() {
            try {
                // Get total conversations
                const { data: analytics, error: analyticsError } = await supabase
                    .from('chatbot_analytics')
                    .select('*');

                if (analyticsError) throw analyticsError;

                // Calculate stats
                const totalConversations = analytics.length;
                const qualifiedLeads = analytics.filter(a => a.lead_score >= 50).length;
                const conversions = analytics.filter(a => a.conversion_action).length;
                const avgMessages = analytics.length > 0 
                    ? Math.round(analytics.reduce((sum, a) => sum + a.total_messages, 0) / analytics.length)
                    : 0;

                // Update UI
                document.getElementById('totalConversations').textContent = totalConversations;
                document.getElementById('qualifiedLeads').textContent = qualifiedLeads;
                document.getElementById('avgMessages').textContent = avgMessages;
                document.getElementById('conversions').textContent = conversions;

            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        async function loadQualifiedLeads() {
            try {
                const { data: leads, error } = await supabase
                    .from('chatbot_analytics')
                    .select('*')
                    .gte('lead_score', 50)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                const container = document.getElementById('qualifiedLeadsList');
                container.innerHTML = '';

                if (leads.length === 0) {
                    container.innerHTML = '<p class="text-gray-400">No qualified leads yet.</p>';
                    return;
                }

                leads.forEach(lead => {
                    const leadCard = document.createElement('div');
                    leadCard.className = 'conversation-card p-4 rounded-lg';
                    
                    const userInfo = lead.user_info || {};
                    const name = userInfo.name || 'Anonymous';
                    const email = userInfo.email || 'No email';
                    const stage = userInfo.stage || 'Unknown stage';
                    
                    leadCard.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-bold text-lg">ðŸ”¥ ${name}</h3>
                                <p class="text-sm text-gray-300">${email}</p>
                                <p class="text-sm text-blue-300">${stage}</p>
                            </div>
                            <div class="text-right">
                                <span class="bg-green-600 px-2 py-1 rounded text-sm">Score: ${lead.lead_score}</span>
                                <p class="text-xs text-gray-400 mt-1">${new Date(lead.created_at).toLocaleDateString()}</p>
                            </div>
                        </div>
                        <div class="text-sm">
                            <p><strong>Messages:</strong> ${lead.total_messages}</p>
                            <p><strong>Duration:</strong> ${Math.floor(lead.conversation_duration / 60)}m ${lead.conversation_duration % 60}s</p>
                            <p><strong>Topics:</strong> ${lead.intents_discussed.join(', ')}</p>
                            ${lead.conversion_action ? `<p><strong>Action:</strong> <span class="text-green-400">${lead.conversion_action}</span></p>` : ''}
                        </div>
                    `;
                    
                    container.appendChild(leadCard);
                });

            } catch (error) {
                console.error('Error loading qualified leads:', error);
            }
        }

        async function loadRecentConversations() {
            try {
                const { data: conversations, error } = await supabase
                    .from('chatbot_analytics')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (error) throw error;

                const container = document.getElementById('conversationsList');
                container.innerHTML = '';

                if (conversations.length === 0) {
                    container.innerHTML = '<p class="text-gray-400">No conversations yet.</p>';
                    return;
                }

                conversations.forEach(conv => {
                    const convCard = document.createElement('div');
                    convCard.className = 'conversation-card p-4 rounded-lg';
                    
                    const userInfo = conv.user_info || {};
                    const name = userInfo.name || 'Anonymous';
                    const isQualified = conv.lead_score >= 50;
                    
                    convCard.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-semibold">${isQualified ? 'ðŸ”¥' : 'ðŸ’¬'} ${name}</h3>
                                <p class="text-sm text-gray-300">Session: ${conv.session_id.substring(0, 20)}...</p>
                            </div>
                            <div class="text-right">
                                <span class="px-2 py-1 rounded text-sm ${isQualified ? 'bg-green-600' : 'bg-gray-600'}">
                                    Score: ${conv.lead_score}
                                </span>
                                <p class="text-xs text-gray-400 mt-1">${new Date(conv.created_at).toLocaleDateString()}</p>
                            </div>
                        </div>
                        <div class="text-sm grid grid-cols-2 gap-4">
                            <div>
                                <p><strong>Messages:</strong> ${conv.total_messages}</p>
                                <p><strong>Duration:</strong> ${Math.floor(conv.conversation_duration / 60)}m</p>
                            </div>
                            <div>
                                <p><strong>Topics:</strong> ${conv.intents_discussed.slice(0, 3).join(', ')}</p>
                                ${conv.conversion_action ? `<p><strong>Action:</strong> <span class="text-green-400">${conv.conversion_action}</span></p>` : ''}
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(convCard);
                });

            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }

        async function loadPopularIntents() {
            try {
                const { data: analytics, error } = await supabase
                    .from('chatbot_analytics')
                    .select('intents_discussed');

                if (error) throw error;

                // Count intent frequency
                const intentCounts = {};
                analytics.forEach(session => {
                    session.intents_discussed.forEach(intent => {
                        intentCounts[intent] = (intentCounts[intent] || 0) + 1;
                    });
                });

                // Sort by frequency
                const sortedIntents = Object.entries(intentCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 8);

                const container = document.getElementById('popularIntents');
                container.innerHTML = '';

                sortedIntents.forEach(([intent, count]) => {
                    const intentCard = document.createElement('div');
                    intentCard.className = 'conversation-card p-4 rounded-lg text-center';
                    intentCard.innerHTML = `
                        <h3 class="font-semibold mb-2">${intent.replace(/_/g, ' ').toUpperCase()}</h3>
                        <p class="text-2xl font-bold text-blue-400">${count}</p>
                        <p class="text-xs text-gray-400">discussions</p>
                    `;
                    container.appendChild(intentCard);
                });

            } catch (error) {
                console.error('Error loading popular intents:', error);
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadAnalytics();
            loadQualifiedLeads();
            loadRecentConversations();
        }, 30000);
    </script>
</body>
</html>